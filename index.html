<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>My Game Website</title>
        <link rel="stylesheet" href="style.css">

    </head>
<body>
    <div class="stars"></div>
    <div class="shooting-star" style="top: 10%; right: -100px; animation-delay: 2s;"></div>
    <div class="shooting-star" style="top: 40%; right: -150px; animation-delay: 6s;"></div>
    <div class="shooting-star" style="top: 70%; right: -120px; animation-delay: 10s;"></div>
    <div class="shooting-star" style="right: 500px; top: -200px; animation-delay: 5s;"></div>
    <div class="shooting-star" style="right: 800px; top: -200px; animation-delay: 7s;"></div>
    <!-- Header Section -->
    <header>
        <h1>Space Invaders</h1>
        
    </header>

    <!-- Navigation Menu -->
    <nav>
        <ul>
            <li><a href="#" class="nav-link" data-screen="home">Home</a></li>
            <li><a href="#" class="nav-link" data-screen="about">About</a></li>
            <li id="settings-nav-item" style="display: none;"><a href="#" class="nav-link" data-screen="settings">Setting</a></li>

            <li id="game-nav-item" style="display: none;"><a href="#" class="nav-link" data-screen="game">Game</a></li>
        </ul>
    </nav>

    <!-- Main Content Area -->
    <main>
        <!--welcome screen-->
        <div id="Welcome" class="screen">
            <h2>Welcome, brave commander</h2>
            
        
            <div class="creators-info">
                <p><b>Game creators:</b></p>
                <p>Yuval Ellins - 206964595</p>
                <p>Idan Duhaviv - 208426197</p>
            </div>
            
            <div class="welcome-buttons">
                <button id="login-button" class="action-button">Login</button>
                <button id="register-button" class="action-button">Register</button>
            </div>
        </div>

            <!-- registration screen -->

        <div id="register-screen" class ="screen">
            <h2>Registration</h2>
            <form id="reg-form">
                <div class = "form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class ="form-group">
                    <label for="passowrd">Password:</label>
                    <input type="password" id="password" name="password"  required>
                    <br>
                    <small class="password-hint">Must include at least 1 number and letter, minimum 8 characters long</small>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password:</label>
                    <input type="password" id="confirmPassword" name="confirmPassword"  required>
                </div>
                <div class="form-group">
                    <label for="firstName">First name</label>
                    <input type ="text" id="firstName" name="firstName"  required>
                </div>
                <div class="form-group">
                    <label for="lastName">Laste name</label>
                    <input type ="text" id="lastName" name="lastName"  required>
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type ="text" id="email" name="email"  required>
                </div>

                <div class="form-group">
                    <label for="birthDay">Date of Birth</label>
                    <input type ="date" id="birthDay" name="birthDay" placeholder="DD-MM-YYYY" required>
                </div>
                <div class="form-group">
                    <button type="submit" id="registerSubmit">Register</button>
                </div>
            </form>
        




        </div>

        <!-- Login Screen -->
        <div id="login-screen" class="screen">
            <h2>Login</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="username-login">Username:</label>
                    <input type="text" id="username-login" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password-login">Password:</label>
                    <input type="password" id="password-login" name="password" required>
                </div>
                <button type="submit">Login</button>
            </form>
        </div>

    
        <!-- Settings screen (only accessible after login) -->
        <div id="settings" class="screen">
          <h2>Game Settings</h2>
          <div class="settings-container">
              <!-- Controls Section -->
              <div class="setting-group">
                  <h3>Controls</h3>
                  <!-- Firing Key -->
                  <div class="form-group">
                      <label for="firing-key">Firing Key:</label>
                      <input type="text" id="firing-key" maxlength="10" value="Space" readonly>
                      <button class="key-change-btn" data-control="firingKey">Change Key</button>
                  </div>
                  
                  <!-- Movement Keys -->
                  <div class="settings-container">
                      <div class="form-group">
                          <label for="move-left-key">Move Left:</label>
                          <input type="text" id="move-left-key" maxlength="10" value="ArrowLeft" readonly>
                          <button class="key-change-btn" data-control="moveLeftKey">Change Key</button>
                      </div>
                      
                      <div class="form-group">
                          <label for="move-right-key">Move Right:</label>
                          <input type="text" id="move-right-key" maxlength="10" value="ArrowRight" readonly>
                          <button class="key-change-btn" data-control="moveRightKey">Change Key</button>
                      </div>
                      
                      <div class="form-group">
                          <label for="move-up-key">Move Up:</label>
                          <input type="text" id="move-up-key" maxlength="10" value="ArrowUp" readonly>
                          <button class="key-change-btn" data-control="moveUpKey">Change Key</button>
                      </div>
                      
                      <div class="form-group">
                          <label for="move-down-key">Move Down:</label>
                          <input type="text" id="move-down-key" maxlength="10" value="ArrowDown" readonly>
                          <button class="key-change-btn" data-control="moveDownKey">Change Key</button>
                      </div>
                      
                  </div>
                  <p class="key-instructions">Click "Change Key" then press your desired key</p>

              </div>
      
              <!-- Game Duration Section -->
              <div class="setting-group">
                  <h3>Game Duration</h3>
                  <div class="form-group">
                      <label for="game-time">Game Time (minutes):</label>
                      <input type="number" id="game-time" min="2" value="2">
                      <span class="setting-hint">Minimum: 2 minutes</span>
                  </div>
              </div>
      
              <div class="setting-group">
                <h3>Appearance</h3>
                <div class="form-group">
                    <label for="player-ship-color">Player Ship Style:</label>
                    <select id="player-ship-color" class="ship-select">
                        <option value="blue">Blue</option>
                        <option value="green" selected>Green</option>
                        <option value="red">Red</option>
                        <option value="gold">Gold</option>
                    </select>
                </div>
                
            </div>
               
              
          </div>
          <!-- Action Buttons -->
          <div class="settings-buttons">
            <button id="start-game" class="action-button">Start Game</button>
            <button id="reset-settings" class="secondary-button">Reset Settings</button>
        </div>
      </div>
      
        <!-- Game Screen (only accessible after login) -->
        <div id="game-screen" class="screen">
            <div id="game-container">
                <div id="game-hud">
                    <div id="score">Score: 0</div>
                    <div id="lives">Lives: 3</div>
                    <div id="timer">Time: 120</div>
                </div>
                <!-- Game canvas or elements will go here -->
                <div id="player-ship"></div> 
                <div id="end-game-overlay" class="game-overlay">
                    <div class="end-message-box" id="end-message-box">
                        <h2 id="end-title">You Lost!</h2>
                        <p id="end-subtitle">Final Score: <span id="final-score">0</span></p>
                        <p class="hint">(Press SPACE to play again)</p>
                    </div>
                   
                </div>
            </div>
            <div class="game-controls">
              <button id="reset-game-btn" class="action-button">Reset Game</button>
            </div>
        </div>

        <!-- Score Screen -->
        <div id="score-screen" class="screen">
            <h2>Score History</h2>
            <div id="score-history" class="score-history-box"></div>

          <div class="button-column">
            <button id="new-game-btn" class="action-button">NEW GAME</button>
            <button id="back-home-btn" class="secondary-button">BACK TO HOME</button>
            </div>
          </div>

        <!-- About Screen -->
        <dialog id="about-dialog" class="modal">
            <div class="modal-content">
                <button id="close-about">X</button>

                <h2>About the Game</h2>
                <p>This game was developed as a Space Invaders style game with several enhancements.</p>
                
                <h3>Game Instructions:</h3>
                <ul>
                  <li>Move the player spaceship using the Arrow Keys (â† â†‘ â†“ â†’).</li>
                  <li>Shoot enemy ships using the Spacebar.</li>
                  <li>Avoid enemy fire and eliminate all enemy ships to win.</li>
                </ul>
                
                <h3>Implemented Features:</h3>
                <ul>
                  <li><b>Timer:</b> A countdown timer shows the remaining time to complete the game.</li>
                  <li><b>Acceleration:</b> Enemy ships and enemy shots speed up every few seconds to increase difficulty.</li>
                </ul>
                <h3>Challenges in developing our game:</h3>
                <ul>
                  <li><b>Collision Detection:</b> Implementing accurate collision detection between shots and ships while maintaining performance.</li>
                  <li><b>Enemy Movement Patterns:</b> Creating challenging but fair enemy movement that changes direction at screen boundaries.</li>
                  <li><b>Custom Controls:</b> Allowing players to rebind keys while preventing conflicts and maintaining game functionality.</li>
                  <li><b>Game State Management:</b> Handling transitions between game states (menu, gameplay, game over) and preserving player data.</li>
                  <li><b>Responsive Design:</b> Ensuring the game adapts to different screen sizes while maintaining playability.</li>
                  <li><b>Sound Management:</b> Implementing audio features that enhance gameplay without overwhelming the player.</li>
                </ul>
                <p>The game was created by BGU SISE students Yuval and Idan as an educational project.</p>
                
            </div>
        </dialog>

        <!-- Add more screens as needed -->
    </main>

    <!-- Footer Section -->
    <footer>
        <p>&copy; 2025 My Game Website. All rights reserved.</p>
        <p>Created for educational purposes</p>
    </footer>

    <script>
        // =======================
    // GLOBAL VARIABLES
    // =======================
    let users = [
      { username: 'p', password: 'testuser', firstName: 'Test', lastName: 'User', email: 'test@test.com', birthDay: '1999-09-09' }
    ];
    let isLogged = false;
    let currentUser = null;
    let scoreHistory = {};
    let playerRespawning = false;
    let activeScreen = null;
    let gamePaused = false;
    let gameEnded = false;
    let playerX = 0;
    let playerY = 20;
    let keysPressed = {};
    let enemies = [];
    let playerShots = [];
    let activeEnemyShot = null;
    let score = 0;
    let lives = 3;
    let timeLeft = 120;
    let shotCooldown = false; 
    let enemyMoveInterval;
    let enemyFireInterval;
    let timerInterval;
    let accelerationInterval;
    let accelerationCount = 0;
    let enemyMoveSpeed = 200;
    let enemyShotSpeed = 5;
    gameSettings = {
    firingKey: ' ',
    moveLeftKey: 'ArrowLeft',
    moveRightKey: 'ArrowRight',
    moveUpKey: 'ArrowUp',
    moveDownKey: 'ArrowDown',
    playerShipColor: 'green',
};


    const soundShot = new Audio('sounds/shot.mp3');
    const soundHit = new Audio('sounds/hit.mp3');
    const soundLose = new Audio('sounds/lost_the_game.mp3');
    let soundVictory = new Audio('sounds/victory.mp3');
    let backgroundMusic = new Audio('sounds/background.mp3');
    backgroundMusic.loop = true;       // ğŸ”„ ×›×“×™ ×©×™×ª× ×’×Ÿ ×‘×œ×•×¤ ×›×œ ×”×–××Ÿ
    backgroundMusic.volume = 0.2;       // ğŸ”‰ ×¢×•×¦××” × ××•×›×” (0 ×¢×“ 1) - ×¤×” ×©××ª×™ 20%

        
    // =======================
    // SCREEN MANAGEMENT
    // =======================
    function showScreen(screenId) {
      if (activeScreen) activeScreen.classList.remove('active');
      const targetScreen = document.getElementById(screenId);
      if (targetScreen) {
        targetScreen.classList.add('active');
        activeScreen = targetScreen;
      }
    }
    
    // =======================
    // DOM READY
    // =======================
    document.addEventListener('DOMContentLoaded', function() {
  // Set active screen
  activeScreen = document.getElementById('Welcome');
  activeScreen.classList.add('active');
  
  // Set up about dialog
  const aboutDialog = document.getElementById('about-dialog');
  if (aboutDialog) {
    // Add click listener to close dialog when clicking outside
    aboutDialog.addEventListener('click', function(event) {
      const dialogDimensions = aboutDialog.getBoundingClientRect();
      if (
        event.clientX < dialogDimensions.left ||
        event.clientX > dialogDimensions.right ||
        event.clientY < dialogDimensions.top ||
        event.clientY > dialogDimensions.bottom
      ) {
        aboutDialog.close();
      }
    });
       // Prevent clicks on dialog content from closing the dialog
       const modalContent = aboutDialog.querySelector('.modal-content');
    if (modalContent) {
      modalContent.addEventListener('click', function(event) {
        event.stopPropagation();
      });
    }
  }
   // Initialize the site
   setupNavigation();
  setupAuth();
  setupSettings();
  setupButtons();
});
  
    // =======================
    // SETUP FUNCTIONS
    // =======================
    function setupNavigation() {
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const screenId = this.getAttribute('data-screen');
          if (screenId === 'game' && !isLogged) {
            alert('Please log in first');
            showScreen('login-screen');
          } else if (screenId === 'home') {
            showScreen('Welcome');
          } else if (screenId === 'about') {
            document.getElementById('about-dialog').showModal();
          } else if (screenId === 'settings') {
            showScreen('settings'); 
          } else {
            showScreen(screenId + '-screen');
          }
        });
      });
    
      document.getElementById('close-about')?.addEventListener('click', () => {
        document.getElementById('about-dialog').close();
      });
    
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') document.getElementById('about-dialog').close();
      });
    }
    
    function setupAuth() {
      document.getElementById('login-button')?.addEventListener('click', () => showScreen('login-screen'));
      document.getElementById('register-button')?.addEventListener('click', () => showScreen('register-screen'));
    
      document.getElementById('reg-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        const confirmPassword = document.getElementById('confirmPassword').value.trim();
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const email = document.getElementById('email').value.trim();
        const birthDay = document.getElementById('birthDay').value.trim();
    
        if (password.length < 8 || !/\d/.test(password) || !/[a-zA-Z]/.test(password)) {
          alert('Password must be at least 8 characters and include letters and numbers.');
          return;
        }
        if (password !== confirmPassword) {
          alert('Passwords do not match.');
          return;
        }
        if (!/^\S+@\S+\.\S+$/.test(email)) {
          alert('Invalid email address.');
          return;
        }
        if (users.some(u => u.username === username)) {
          alert('Username already exists.');
          return;
        }
    
        users.push({ username, password, firstName, lastName, email, birthDay });
        alert('Registration successful. Please log in.');
        showScreen('login-screen');
      });
    
      document.getElementById('login-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const username = document.getElementById('username-login').value.trim();
        const password = document.getElementById('password-login').value.trim();
        const user = users.find(u => u.username === username && u.password === password);
    
        if (user) {
          currentUser = user;
          isLogged = true;
          document.getElementById('settings-nav-item').style.display = 'inline-block';
          document.getElementById('game-nav-item').style.display = 'inline-block';
          if (!scoreHistory[currentUser.username]) scoreHistory[currentUser.username] = [];
          showScreen('settings');
        } else {
          alert('Invalid username or password.');
        }
      });
    }
    
    function setupSettings() {
  // Add event listeners for all key change buttons
  document.querySelectorAll('.key-change-btn').forEach(button => {
    button.addEventListener('click', function() {
      const controlType = this.getAttribute('data-control');
      const inputId = getInputIdForControl(controlType);
      const input = document.getElementById(inputId);
      
      input.value = 'Press a key...';
      
      // Remove any existing key listener to avoid duplicates
      if (window.activeKeyListener) {
        document.removeEventListener('keydown', window.activeKeyListener);
      }
      
      // Create and store the key listener
      window.activeKeyListener = function(e) {
        e.preventDefault();
        
        let keyName = e.key;
        let displayName = keyName;
        
        if (keyName === ' ') displayName = 'Space';
        
        gameSettings[controlType] = keyName;
        input.value = displayName;
        
        document.removeEventListener('keydown', window.activeKeyListener);
        window.activeKeyListener = null;
      };
      
      document.addEventListener('keydown', window.activeKeyListener);
    });
  });
  
  const playerShipSelect = document.getElementById('player-ship-color');
  
  // Initialize with default values
  playerShipSelect.value = gameSettings.playerShipColor;
  
  playerShipSelect?.addEventListener('change', function() {
    gameSettings.playerShipColor = this.value;
    updateShipPreview('player');
  });
  
  addShipPreviews();
 
 
  
  document.getElementById('start-game')?.addEventListener('click', startNewGame);
  document.getElementById('reset-settings')?.addEventListener('click', resetSettings);
}
function addShipPreviews() {
  const playerSelect = document.getElementById('player-ship-color');
  
  // Add player ship preview
  if (!document.getElementById('player-ship-preview')) {
    const playerPreview = document.createElement('span');
    playerPreview.id = 'player-ship-preview';
    playerPreview.className = 'ship-preview';
    // Corrected path with images folder
    playerPreview.style.backgroundImage = `url('images/user ${playerSelect.value} ship.png')`;
    playerSelect.parentNode.appendChild(playerPreview);
  }
  
  // Update initial preview
  updateShipPreview('player');
}

function updateShipPreview(type) {
  if (type === 'player') {
    const preview = document.getElementById('player-ship-preview');
    const color = gameSettings.playerShipColor;
    if (preview) {
      preview.style.backgroundImage = `url('images/user ${color} ship.png')`;
    }
  }
}


// Helper function to get the corresponding input ID for a control type
function getInputIdForControl(controlType) {
  switch(controlType) {
    case 'firingKey': return 'firing-key';
    case 'moveLeftKey': return 'move-left-key';
    case 'moveRightKey': return 'move-right-key';
    case 'moveUpKey': return 'move-up-key';
    case 'moveDownKey': return 'move-down-key';
    default: return '';
  }
}

function resetSettings() {
  // Reset all controls to defaults
  gameSettings.firingKey = ' ';
  gameSettings.moveLeftKey = 'ArrowLeft';
  gameSettings.moveRightKey = 'ArrowRight';
  gameSettings.moveUpKey = 'ArrowUp';
  gameSettings.moveDownKey = 'ArrowDown';
  gameSettings.playerShipColor = 'green';
  
  // Update the UI to show default values
  document.getElementById('firing-key').value = 'Space';
  document.getElementById('move-left-key').value = 'ArrowLeft';
  document.getElementById('move-right-key').value = 'ArrowRight';
  document.getElementById('move-up-key').value = 'ArrowUp';
  document.getElementById('move-down-key').value = 'ArrowDown';
  
  // Reset player ship color
  document.getElementById('player-ship-color').value = 'green';
  
  // Update player preview
  updateShipPreview('player');
  
  // Reset other settings
  document.getElementById('game-time').value = 2;
}
function setupButtons() {
  // Set up NEW GAME button on score screen
  const newGameBtn = document.getElementById('new-game-btn');
  if (newGameBtn) {
    newGameBtn.addEventListener('click', function() {
      startNewGame();
    });
  }
  
  // Set up BACK TO HOME button on score screen
  const backHomeBtn = document.getElementById('back-home-btn');
  if (backHomeBtn) {
    backHomeBtn.addEventListener('click', function() {
      showScreen('Welcome');
    });
  }
  
  // Set up RESET GAME button on game screen
  const resetGameBtn = document.getElementById('reset-game-btn');
  if (resetGameBtn) {
    resetGameBtn.addEventListener('click', function() {
      // Only if the game isn't already over
      if (!gameEnded) {
        // Ask for confirmation to avoid accidental resets
        if (confirm('Are you sure you want to reset the game? Your current progress will be lost.')) {
          startNewGame();
        }
      } else {
        // If game is already over, no need for confirmation
        startNewGame();
      }
    });
  }
}
document.addEventListener('keydown', function(e) {
  // List of keys that need preventDefault to avoid scrolling the page
  const keysToPrevent = [' ', 'Spacebar', 'Space', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
  
  // Add custom keys to the prevention list
  if (gameSettings.firingKey) keysToPrevent.push(gameSettings.firingKey);
  if (gameSettings.moveLeftKey) keysToPrevent.push(gameSettings.moveLeftKey);
  if (gameSettings.moveRightKey) keysToPrevent.push(gameSettings.moveRightKey);
  if (gameSettings.moveUpKey) keysToPrevent.push(gameSettings.moveUpKey);
  if (gameSettings.moveDownKey) keysToPrevent.push(gameSettings.moveDownKey);
  
  if (keysToPrevent.includes(e.key) || keysToPrevent.includes(e.code)) {
    if (!['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) {
      e.preventDefault();
    }
  }

  keysPressed[e.key] = true;

  // Use custom firing key
  if (e.key === gameSettings.firingKey && !gamePaused && !gameEnded) {
    firePlayerShot();
  }

  // Handle game restart after game over
  if (gameEnded && (e.key === ' ' || e.code === 'Space')) {
    document.removeEventListener('keydown', restartListener);
    showScreen('score-screen');
    renderScoreTable();
  }

  // Close the about dialog with Escape
  if (e.key === 'Escape') {
    document.getElementById('about-dialog')?.close();
  }
});

document.addEventListener('keyup', function(e) {
  keysPressed[e.key] = false;
});

// Update the movement interval to use custom movement keys
setInterval(() => {
  if (!gameEnded && !gamePaused) {
    const step = 10;
    if (keysPressed[gameSettings.moveLeftKey]) movePlayer(-step, 0);
    if (keysPressed[gameSettings.moveRightKey]) movePlayer(step, 0);
    if (keysPressed[gameSettings.moveUpKey]) movePlayer(0, step);
    if (keysPressed[gameSettings.moveDownKey]) movePlayer(0, -step);
  }
}, 30);
    // =======================
    // GAME CORE
    // =======================

    
    function startNewGame() {
    resetGame();
    showScreen('game-screen');
    if (!backgroundMusic.paused) {
    backgroundMusic.pause()
    backgroundMusic.currentTime = 0;
    }
    backgroundMusic.play();

 

    // âœ… ×ª×•×¡×¤×ª ×—×©×•×‘×”: ×œ×”×¢×œ×™× ××ª ×ª×•×¦××•×ª ×”××©×—×§ ×”×§×•×“×
    const endOverlay = document.getElementById("end-game-overlay");
    if (endOverlay) {
        endOverlay.classList.remove("visible");
        endOverlay.style.display = "none"; // ×œ×”×¢×œ×™× ×’× ×œ×—×œ×•×˜×™×Ÿ
    }

    spawnPlayer();
    spawnEnemies();
    updateHUD();
    startTimer();
    
    enemyMoveInterval = setInterval(moveEnemies, enemyMoveSpeed);
    enemyFireInterval = setInterval(fireEnemyShot, 500);
    accelerationInterval = setInterval(accelerateEnemies, 5000);
    }

    
   
    
    function resetGame() {
      clearInterval(enemyMoveInterval);
      clearInterval(enemyFireInterval);
      clearInterval(timerInterval);
      clearInterval(accelerationInterval);
    
      document.getElementById('game-container').querySelectorAll('.enemy-ship, .player-shot, .enemy-shot').forEach(e => e.remove());
    
      enemies = [];
      activePlayerShot = null;
      activeEnemyShot = null;
      score = 0;
      lives = 3;
      timeLeft = parseInt(document.getElementById('game-time').value || 2) * 60;
      enemyMoveSpeed = 200;
      enemyShotSpeed = 5;
      accelerationCount = 0;
      gameEnded = false;
      gamePaused = false;
    }
    
    function updateHUD() {
      document.getElementById('score').textContent = `Score: ${score}`;
      document.getElementById('lives').textContent = `Lives: ${lives}`;
      document.getElementById('timer').textContent = `Time: ${timeLeft}`;
    }
    
    function spawnPlayer() {
      const player = document.getElementById('player-ship');
      const container = document.getElementById('game-container');
      
      // Corrected path with images folder
      player.style.backgroundImage = `url('images/user ${gameSettings.playerShipColor} ship.png')`;
      
      // Calculate center position
      const containerWidth = container.clientWidth;
      const playerWidth = player.offsetWidth || 50; 
      // Set playerX to center the ship horizontally
      playerX = (containerWidth / 2) - (playerWidth / 2);
      // Set playerY to a suitable height from the bottom
      playerY = 20;
      
      // Apply the position
      player.style.left = `${playerX}px`;
      player.style.bottom = `
      ${playerY}px`;
    }
    function spawnEnemies() {
  const container = document.getElementById('game-container');
  const rows = 4;
  const cols = 5;
  const spacing = 60;

  // Define colors for each row (bottom to top)
  const rowColors = ['red', 'blue', 'green', 'gold'];

  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      const enemy = document.createElement('div');
      enemy.className = 'enemy-ship';
      
      enemy.classList.add(`row-${r}`);
      const colorIndex = r; // Use row index directly to get color
      const enemyColor = rowColors[colorIndex];
      enemy.style.backgroundImage = `url('images/enemy ${enemyColor}.png')`;
      
      enemy.style.left = `${100 + c * spacing}px`;
      enemy.style.top = `${50 + r * spacing}px`;
      
      container.appendChild(enemy);
      enemies.push(enemy);
    }
  }
}

    let enemyDirection = 1; // 1=right, -1=left
    const enemyStep = 10;
    
    function moveEnemies() {
      if (enemies.length === 0) return;
    
      const container = document.getElementById('game-container');
      const containerWidth = container.clientWidth;
    
      let leftmost = Infinity;
      let rightmost = -Infinity;
    
      enemies.forEach(enemy => {
        const x = parseFloat(enemy.style.left);
        leftmost = Math.min(leftmost, x);
        rightmost = Math.max(rightmost, x + enemy.offsetWidth);
      });
    
      if (rightmost + enemyStep * enemyDirection > containerWidth || leftmost + enemyStep * enemyDirection < 0) {
        enemyDirection *= -1;
      }
    
      enemies.forEach(enemy => {
        enemy.style.left = (parseFloat(enemy.style.left) + enemyStep * enemyDirection) + 'px';
      });
    }
    

    function fireEnemyShot() {
      if (activeEnemyShot) return; // Only one active enemy shot at a time
      if (enemies.length === 0) return; // No enemies to fire

      const randomEnemy = enemies[Math.floor(Math.random() * enemies.length)];
      const shot = document.createElement('div');
      shot.className = 'enemy-shot';

      const x = parseFloat(randomEnemy.style.left) + randomEnemy.offsetWidth / 2 - 4;
      const y = parseFloat(randomEnemy.style.top) + randomEnemy.offsetHeight;

      shot.style.left = `${x}px`;
      shot.style.top = `${y}px`;

      document.getElementById('game-container').appendChild(shot);
      activeEnemyShot = shot;

      moveShot(shot, 'enemy');
    }


    function moveShot(shot, type) {
  const container = document.getElementById('game-container');
  const hudHeight = 40; 
  const containerHeight = container.clientHeight - hudHeight;

  const interval = setInterval(() => {
    let pos = type === 'enemy' ? parseFloat(shot.style.top) : parseFloat(shot.style.bottom);
    pos += type === 'enemy' ? enemyShotSpeed : 10;
    
    if (type === 'enemy') {
      shot.style.top = `${pos}px`;
      checkEnemyShotCollision(shot, interval);
      
      // Check if enemy shot has traveled 3/4 of the screen height
      const shotTravelDistance = pos - hudHeight; // Distance traveled from the top of play area
      if (shotTravelDistance >= (containerHeight * 0.75) && activeEnemyShot === shot) {
        // Shot has traveled 3/4 of the way - fire another shot if possible
        activeEnemyShot = null; // Allow a new shot to be fired
        fireEnemyShot(); // Fire a new shot
      }
      
      // If enemy shot goes beyond screen bottom
      if (pos > containerHeight + hudHeight) {
        clearInterval(interval);
        shot.remove();
        // Only reset activeEnemyShot if this is the active shot
        if (activeEnemyShot === shot) {
          activeEnemyShot = null;
        }
      }
    } else {
      shot.style.bottom = `${pos}px`;
      checkPlayerShotCollision(shot, interval);
      
      // If player shot goes beyond screen top
      if (pos > containerHeight) {
        clearInterval(interval);
        shot.remove();
        const index = playerShots.indexOf(shot);
        if (index > -1) {
          playerShots.splice(index, 1);
        }
      }
    }
  }, 20);
}

function firePlayerShot() {
  // Don't allow shooting while in cooldown or respawning
  if (shotCooldown || playerRespawning) {
    return;
  }

  const player = document.getElementById('player-ship');
  const shot = document.createElement('div');
  shot.className = 'player-shot';

  const x = parseFloat(player.style.left) + player.offsetWidth / 2 - 3;
  const y = parseFloat(player.style.bottom) + player.offsetHeight;

  shot.style.left = `${x}px`;
  shot.style.bottom = `${y}px`;

  document.getElementById('game-container').appendChild(shot);
  playerShots.push(shot);

  moveShot(shot, 'player');

  // Play sound effect
  const newSound = soundShot.cloneNode(); 
  newSound.volume = 0.5;
  newSound.play();
  
  // Start cooldown
  shotCooldown = true;
  
  // Reset cooldown after delay
  setTimeout(() => {
    shotCooldown = false;
  }, 300);
}
    
    function checkEnemyShotCollision(shot, interval) {
      const player = document.getElementById('player-ship');
      const shotRect = shot.getBoundingClientRect();
      const playerRect = player.getBoundingClientRect();
    
      if (shotRect.left < playerRect.right &&
          shotRect.right > playerRect.left &&
          shotRect.top < playerRect.bottom &&
          shotRect.bottom > playerRect.top) {
        clearInterval(interval);
        shot.remove();
        activeEnemyShot = null;
        handlePlayerHit();
      }
    }
    
    function checkPlayerShotCollision(shot, interval) {
  for (let i = 0; i < enemies.length; i++) {
    const enemy = enemies[i];
    const shotRect = shot.getBoundingClientRect();
    const enemyRect = enemy.getBoundingClientRect();

    if (shotRect.left < enemyRect.right &&
        shotRect.right > enemyRect.left &&
        shotRect.top < enemyRect.bottom &&
        shotRect.bottom > enemyRect.top) {
      
      clearInterval(interval);
      shot.remove();
      activePlayerShot = null;

      // × ×™×§×•×“ ×œ×¤×™ ×©×•×¨×”
      let points = 5; // ×‘×¨×™×¨×ª ××—×“×œ: 5 × ×§×•×“×•×ª
      if (enemy.classList.contains('row-2')) {
        points = 10;
      } else if (enemy.classList.contains('row-1')) {
        points = 15;
      } else if (enemy.classList.contains('row-0')) {
        points = 20;
      }

      score += points; // ×”×•×¡×¤×ª ×”× ×™×§×•×“ ×”× ×›×•×Ÿ!

      enemy.remove();
      enemies.splice(i, 1);
      updateHUD();
      checkWin();
      break;
    }
  }
}


    
function handlePlayerHit() {
  lives--;
  updateHUD();

  if (lives <= 0) {
    soundLose.play();
    endGame('lost');
  } else {
    // Set respawning flag to true
    playerRespawning = true;
    
    // Hide the player ship
    const player = document.getElementById('player-ship');
    player.style.display = 'none';
    
    // After a delay, respawn the player at the center-bottom position
    setTimeout(() => {
      // Reset player position to center bottom (original spawn point)
      const container = document.getElementById('game-container');
      const playerWidth = player.offsetWidth || 50;
      
      // Calculate center position (same as in spawnPlayer function)
      const containerWidth = container.clientWidth;
      
      // Reset playerX to center the ship horizontally
      playerX = (containerWidth / 2) - (playerWidth / 2);
      // Reset playerY to a suitable height from the bottom
      playerY = 20;
      
      // Apply the new position
      player.style.left = `${playerX}px`;
      player.style.bottom = `${playerY}px`;
      
      // Make the player visible again
      player.style.display = 'block';
      
      // Reset respawning flag
      playerRespawning = false;
    }, 1000); // 1 second delay before respawning
  }
}
    
    function startTimer() {
      timerInterval = setInterval(() => {
        timeLeft--;
        updateHUD();
        if (timeLeft <= 0) endGame('time');
      }, 1000);
    }
    
    function accelerateEnemies() {
      if (accelerationCount >= 4) return;
      accelerationCount++;
      enemyMoveSpeed = Math.max(50, enemyMoveSpeed - 30);
      enemyShotSpeed += 1;
      clearInterval(enemyMoveInterval);
      enemyMoveInterval = setInterval(moveEnemies, enemyMoveSpeed);
    }
    
    function endGame(reason) {
  gameEnded = true;

  if (!backgroundMusic.paused) {
    backgroundMusic.pause();
    backgroundMusic.currentTime = 0;
  }

  clearInterval(enemyMoveInterval);
  clearInterval(enemyFireInterval);
  clearInterval(timerInterval);
  clearInterval(accelerationInterval);

  const overlay = document.getElementById('end-game-overlay');

  overlay.classList.add('visible');
  overlay.style.display = 'flex';

  const title = document.getElementById('end-title');
  const finalScore = document.getElementById('final-score');

  finalScore.textContent = score;

  if (reason === 'lost') {
    title.textContent = 'You Lost!';
    soundLose.play();
  } else if (reason === 'time') {
    if (score >= 100) {
      title.textContent = 'Winner!';
      soundVictory.play();
    } else {
      title.textContent = 'You can do better';
      soundLose.play();
    }
  } else {
    title.textContent = 'Victory!';
    soundVictory.play();
  }

  // Calculate elapsed time (original time - remaining time)
  const originalTime = parseInt(document.getElementById('game-time').value || 2) * 60;
  const elapsedTime = originalTime - timeLeft;
  
  // Save both score and time to history
  if (currentUser && currentUser.username) {
    if (!scoreHistory[currentUser.username]) scoreHistory[currentUser.username] = [];
    // Store an object with both score and time
    scoreHistory[currentUser.username].push({
      score: score,
      time: elapsedTime
    });
  }

  document.addEventListener('keydown', restartListener);
}



    
    function checkWin() {
      if (enemies.length === 0) {
        endGame('victory');
      }
    }
    
    function restartListener(e) {
      if (e.key === ' ') {
        document.removeEventListener('keydown', restartListener);
        showScreen('score-screen');
        renderScoreTable();
      }
    }
    function renderScoreTable() {
  const history = scoreHistory[currentUser.username] || [];
  const container = document.getElementById('score-history');
  container.innerHTML = "<h3>Your Scores</h3>";

  if (history.length === 0) {
    container.innerHTML += "<p>No scores yet!</p>";
    return;
  }

  const table = document.createElement('table');
  table.className = 'score-table';

  const header = document.createElement('tr');
  header.innerHTML = "<th>Rank</th><th>Score</th><th>Time</th>";
  table.appendChild(header);

  // Sort by score (highest first)
  history.sort((a, b) => b.score - a.score).forEach((entry, index) => {
    const row = document.createElement('tr');
    
    // Format time as MM:SS
    const minutes = Math.floor(entry.time / 60);
    const seconds = entry.time % 60;
    const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    row.innerHTML = `
      <td>${index + 1}</td>
      <td>${entry.score}</td>
      <td>${formattedTime}</td>
    `;
    table.appendChild(row);
  });

  container.appendChild(table);
}
    
    // Keyboard movement
// HANDLER ××—×“ ×•×™×—×™×“ ×œ-×›×œ ×”×§×©×•×ª ×‘××§×œ×“×ª
document.addEventListener('keydown', function(e) {
  // ×‘×™×˜×•×œ ×‘×¨×™×¨×ª ××—×“×œ ×¢×‘×•×¨ Space ×•-Arrow ××§×©×™×
  const keysToPrevent = [' ', 'Spacebar', 'Space', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
  
  if (keysToPrevent.includes(e.key) || keysToPrevent.includes(e.code)) {
    if (!['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) {
      e.preventDefault();
    }
  }

  keysPressed[e.key] = true;

  if (e.key === gameSettings.firingKey && !gamePaused && !gameEnded) {
    firePlayerShot();
}


  if (gameEnded && (e.key === ' ' || e.code === 'Space')) {
    document.removeEventListener('keydown', restartListener);
    showScreen('score-screen');
    renderScoreTable();
  }

  if (e.key === 'Escape') {
    document.getElementById('about-dialog')?.close();
  }
});

document.addEventListener('keyup', function(e) {
  keysPressed[e.key] = false;
});


    
    setInterval(() => {
      if (!gameEnded) {
        const step = 10;
        if (keysPressed['ArrowLeft']) movePlayer(-step, 0);
        if (keysPressed['ArrowRight']) movePlayer(step, 0);
        if (keysPressed['ArrowUp']) movePlayer(0, step);
        if (keysPressed['ArrowDown']) movePlayer(0, -step);
      }
    }, 30);
    
    function movePlayer(dx, dy) {
      const player = document.getElementById('player-ship');
      const container = document.getElementById('game-container');
      const hudHeight = 40;

      const containerWidth = container.clientWidth;
      const containerHeight = container.clientHeight - hudHeight; // Adjust for HUD
      const playerWidth = player.offsetWidth;
      const playerHeight = player.offsetHeight;

      // Horizontal constraints remain the same
      playerX = Math.min(Math.max(playerX + dx, 30), containerWidth - playerWidth - 30);
      
      // Vertical constraints - limit to 40% of visible game area (excluding HUD)
      const maxHeight = containerHeight * 0.4;
      playerY = Math.min(Math.max(playerY + dy, 30), maxHeight);

      player.style.left = `${playerX}px`;
      player.style.bottom = `${playerY}px`;
    }
    
    
      </script>
    
    </body>
    </html>
